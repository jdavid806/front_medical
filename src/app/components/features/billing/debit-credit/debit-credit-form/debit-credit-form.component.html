<!-- Main Header Section -->
<div class="flex flex-col md:flex-row items-stretch md:items-center gap-4 md:gap-0 mb-4 bg-white p-4 md:p-3 rounded-lg shadow-md">
  <!-- Back Button -->
  <div class="w-full md:w-auto md:flex-1 flex justify-start">
    <p-button
      label="{{ 'DEBIT_CREDIT_NOTES' | translate }} - {{ 'CREATE_DEBIT_CREDIT_NOTE' | translate }}"
      icon="pi pi-arrow-left"
      styleClass="p-button-text p-button-secondary w-full md:w-auto justify-start"
      [raised]="true"
      routerLink="/billing/debit-credit">
    </p-button>
  </div>

  <!-- Centered Title -->
  <div class="w-full mr-8 md:flex-1 px-0 md:px-4">
    <h1 class="text-xl md:text-2xl font-bold mb-1 inline-block">
      {{ "CREATE_NEW_DEBIT_CREDIT_NOTE" | translate }}
      <div class="w-16 md:w-20 h-1 bg-blue-500 mx-auto mt-2 md:mt-1"></div>
    </h1>
  </div>
</div>

<div class="form-container p-4">
  <form [formGroup]="form" class="space-y-6">
    <!-- Información general -->
    <p-card class="mb-2" [style]="{ 'border': '1px solid #e2e8f0', 'box-shadow': 'none' , 'margin-bottom': '1.5rem' }">
      <h3 class="text-lg font-semibold mb-4"><i class="pi pi-user-edit mr-2 mt-1 text-blue-500"></i> {{"BASIC_INFO" | translate}}</h3>
      <div class="form-grid-basic grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 ml-1">
        <!-- Invoice Reference -->
        <div class="form-inputElement rounded bg-gray-50">
          <p class="font-normal mb-2 text-gray-700">{{ "INVOICE" | translate }}</p>
          <p-select
            [options]="invoiceOptions"
            formControlName="invoice"
            optionLabel="number"
            placeholder="{{ 'SELECT_INVOICE' | translate }}"
            class="w-full"
            [ngClass]="{'ng-invalid ng-dirty': form.get('invoice')?.invalid && form.get('invoice')?.touched}"
            [filter]="true"
            filterBy="number"
            [showClear]="true">
          </p-select>
        </div>

        <!-- Note Number -->
        <div class="form-inputElement border border-gray-200 rounded bg-gray-50">
          <p class="font-normal text-gray-700">{{ "DEBIT_CREDIT_NOTE_NUMBER" | translate }}</p>
          <input
            type="text"
            pInputText
            placeholder="{{ 'ENTER_NOTE_NUMBER' | translate }}"
            class="w-full"
            formControlName="noteNumber"
            [ngClass]="{'ng-invalid ng-dirty': form.get('noteNumber')?.invalid && form.get('noteNumber')?.touched}"
          />
        </div>

        <!-- Note Type -->
        <div class="form-inputElement rounded bg-gray-50">
          <p class="font-normal mb-2 text-gray-700">{{ "TYPE" | translate }}</p>
          <p-select
            [options]="typeOptions"
            formControlName="type"
            optionLabel="name"
            placeholder="{{ 'SELECT_TYPE' | translate }}"
            class="w-full"
            [ngClass]="{'ng-invalid ng-dirty': form.get('type')?.invalid && form.get('type')?.touched}"
            [filter]="true"
            filterBy="name"
            [showClear]="true">
          </p-select>
        </div>

        <!-- Customer -->
        <div class="form-inputElement border border-gray-200 rounded bg-gray-50">
          <p class="font-normal text-gray-700">{{ "CUSTOMERS" | translate }}</p>
          <p-select
            [options]="customers"
            formControlName="customer"
            optionLabel="fullName"
            placeholder="{{ 'SELECT_CUSTOMER' | translate }}"
            class="w-full"
            [ngClass]="{'ng-invalid ng-dirty': form.get('customer')?.invalid && form.get('customer')?.touched}"
            [filter]="true"
            filterBy="fullName"
            [showClear]="true">
          </p-select>
        </div>

        <!-- Contact -->
        <div class="form-inputElement border border-gray-200 rounded bg-gray-50">
          <p class="font-normal text-gray-700">{{ "CONTACT" | translate }}</p>
          <p-select
            [options]="contactOptions"
            formControlName="contact"
            optionLabel="name"
            placeholder="{{ 'SELECT_CONTACT' | translate }}"
            class="w-full"
            [ngClass]="{'ng-invalid ng-dirty': form.get('contact')?.invalid && form.get('contact')?.touched}"
            [filter]="true"
            filterBy="name"
            [showClear]="true">
          </p-select>
        </div>

        <!-- Creation Date -->
        <div class="form-inputElement border border-gray-200 rounded bg-gray-50">
          <p class="font-normal text-gray-700">{{ "CREATION_DATE" | translate }}</p>
          <p-datepicker
            formControlName="creationDate"
            [iconDisplay]="'input'"
            [showIcon]="true"
            [showButtonBar]="true"
            inputId="creationDate"
            placeholder="dd/mm/yy"
            dateFormat="dd/mm/yy"
            inputStyleClass="w-full"
            styleClass="w-full"
            [ngClass]="{'ng-invalid ng-dirty': form.get('creationDate')?.invalid && form.get('creationDate')?.touched}">
          </p-datepicker>
        </div>

        <!-- Cost Center -->
        <div class="form-inputElement border border-gray-200 rounded bg-gray-50">
          <p class="font-normal text-gray-700">{{ "COST_CENTER" | translate }}</p>
          <p-select
            [options]="costCenterOptions"
            formControlName="costCenter"
            optionLabel="name"
            placeholder="{{ 'SELECT_COST_CENTER' | translate }}"
            class="w-full"
            [ngClass]="{'ng-invalid ng-dirty': form.get('costCenter')?.invalid && form.get('costCenter')?.touched}"
            [filter]="true"
            filterBy="name"
            [showClear]="true">
          </p-select>
        </div>

        <!-- Seller -->
        <div class="form-inputElement border border-gray-200 rounded bg-gray-50">
          <p class="font-normal text-gray-700">{{ "SELLER" | translate }}</p>
          <p-select
            [options]="sellerOptions"
            formControlName="seller"
            optionLabel="name"
            placeholder="{{ 'SELECT_SELLER' | translate }}"
            class="w-full"
            [ngClass]="{'ng-invalid ng-dirty': form.get('seller')?.invalid && form.get('seller')?.touched}"
            [filter]="true"
            filterBy="name"
            [showClear]="true">
          </p-select>
        </div>

        <!-- CUFE -->
        <!-- <div class="form-inputElement border border-gray-200 rounded bg-gray-50">
          <p class="font-normal text-gray-700">{{ "CUFE" | translate }}</p>
          <input
            type="text"
            pInputText
            placeholder="{{ 'ENTER_CUFE' | translate }}"
            class="w-full"
            formControlName="cufe"
            [ngClass]="{'ng-invalid ng-dirty': form.get('cufe')?.invalid && form.get('cufe')?.touched}"
          />
        </div> -->



        <!-- DIAN Reason -->
        <!-- <div class="form-inputElement border border-gray-200 rounded bg-gray-50">
          <p class="font-normal text-gray-700">{{ "DIAN_REASON" | translate }}</p>
          <p-select
            [options]="dianReasonOptions"
            formControlName="dianReason"
            optionLabel="name"
            placeholder="{{ 'SELECT_DIAN_REASON' | translate }}"
            class="w-full"
            [ngClass]="{'ng-invalid ng-dirty': form.get('dianReason')?.invalid && form.get('dianReason')?.touched}"
            [filter]="true"
            filterBy="name"
            [showClear]="true">
          </p-select>
        </div> -->

      </div>
    </p-card>

    <!-- Información de facturación -->
    <p-card class="mb-4" [style]="{ 'border': '1px solid #e2e8f0', 'box-shadow': 'none', 'margin-bottom': '1.5rem' }">
      <h3 class="text-lg font-semibold mb-4"><i class="pi pi-barcode mr-2 mt-1 text-blue-500"></i>{{ 'INVOICE_INFO' | translate }}</h3>

      <div class="parent-card border border-gray-200 rounded p-4 bg-white">
        <table class="product-table w-full border-collapse">
          <thead>
            <tr class="border-b border-gray-200 bg-gray-100">
              <th class="text-center text-gray-700 font-semibold">{{ 'PRODUCT' | translate }}</th>
              <th class="text-center text-gray-700 font-semibold">{{ 'DESCRIPTION' | translate }}</th>
              <th class="text-center text-gray-700 font-semibold">{{ 'AMOUNT' | translate }}</th>
              <th class="text-center text-gray-700 font-semibold">{{ 'UNIT_VALUE' | translate }}</th>
              <th class="text-center text-gray-700 font-semibold">{{ 'PERCENTAGE_DISCOUNT' | translate }}</th>
              <th class="text-center text-gray-700 font-semibold">{{ 'TAX_CHARGE' | translate }}</th>
              <th class="text-center text-gray-700 font-semibold">{{ 'WITHHOLDING_TAX' | translate }}</th>
              <th class="text-center text-gray-700 font-semibold">{{ 'TOTAL_VALUE' | translate }}</th>
              <th class="text-center text-gray-700 font-semibold">{{ 'ACTIONS' | translate }}</th>
            </tr>
          </thead>
          <tbody>
            @for(procedure of proceduresArray; track procedure; let i = $index) {
            <tr class="border-b border-gray-200 hover:bg-gray-50">
              <td class="p-3 bg-gray-50">
                <p-select
                  formControlName="product"
                  [options]="productOptions"
                  placeholder="{{ 'SELECT_PRODUCT' | translate }}"
                  class="w-full"
                  [ngClass]="{'ng-invalid ng-dirty': form.get('product')?.invalid && form.get('product')?.touched}"
                  [filter]="true"
                  filterBy="name"
                  optionLabel="name"
                  [showClear]="true">
                </p-select>
              </td>
              <td class="p-3 bg-gray-50">
                <input
                  type="text"
                  pInputText
                  placeholder="{{ 'ENTER_DESCRIPTION' | translate }}"
                  class="w-full"
                  formControlName="description"
                  [ngClass]="{'ng-invalid ng-dirty': form.get('description')?.invalid && form.get('description')?.touched}"
                />
              </td>
              <td class="p-3 bg-gray-50">
                <input
                  type="text"
                  pInputText
                  placeholder="{{ 'ENTER_QUANTITY' | translate }}"
                  class="w-full"
                  formControlName="quantity"
                  [ngClass]="{'ng-invalid ng-dirty': form.get('quantity')?.invalid && form.get('quantity')?.touched}"
                />
              </td>
              <td class="p-3 bg-gray-50">
                <input
                  type="text"
                  pInputText
                  placeholder="{{ 'ENTER_UNIT_VALUE' | translate }}"
                  class="w-full"
                  formControlName="unitValue"
                  [ngClass]="{'ng-invalid ng-dirty': form.get('unitValue')?.invalid && form.get('unitValue')?.touched}"
                />
              </td>
              <td class="p-3 bg-gray-50">
                <input
                  type="text"
                  pInputText
                  placeholder="{{ 'ENTER_DISCOUNT' | translate }}"
                  class="w-full"
                  formControlName="discount"
                  [ngClass]="{'ng-invalid ng-dirty': form.get('discount')?.invalid && form.get('discount')?.touched}"
                />
              </td>
              <td class="p-3 bg-gray-50">
                <p-select
                  [options]="chargeTaxOptions"
                  formControlName="chargeTax"
                  placeholder="{{ 'SELECT_TAX_CHARGE' | translate }}"
                  class="w-full"
                  [ngClass]="{'ng-invalid ng-dirty': form.get('chargeTax')?.invalid && form.get('chargeTax')?.touched}"
                  [filter]="true"
                  filterBy="name"
                  optionLabel="name"
                  [showClear]="true">
                </p-select>
              </td>
              <td class="p-3 bg-gray-50">
                <p-select
                  [options]="withholdingTaxOptions"
                  formControlName="withholdingTax"
                  placeholder="{{ 'SELECT_WITHHOLDING_TAX' | translate }}"
                  class="w-full"
                  [ngClass]="{'ng-invalid ng-dirty': form.get('withholdingTax')?.invalid && form.get('withholdingTax')?.touched}"
                  [filter]="true"
                  filterBy="name"
                  optionLabel="name"
                  [showClear]="true">
                </p-select>
              </td>
              <td class="p-3 bg-gray-50">
                <input
                  type="text"
                  pInputText
                  placeholder="{{ 'TOTAL_VALUE' | translate }}"
                  class="w-full"
                  formControlName="totalValue"
                  [ngClass]="{'ng-invalid ng-dirty': form.get('totalValue')?.invalid && form.get('totalValue')?.touched}"
                  readonly
                />
              </td>
              <td class="p-3 bg-gray-50">
                <p-button icon="pi pi-trash" [text]="true" severity="danger" (click)="removeProcedure(i)" />
              </td>
            </tr>
            }
          </tbody>
        </table>

        <!-- Botón para añadir procedimiento -->
        <p class="add-text mt-4 flex items-center text-blue-500 cursor-pointer hover:text-blue-700"
          (click)="addProcedure()">
          <i class="pi pi-plus mr-2"></i> {{ 'ADD' | translate }}
        </p>

        <!-- Total -->
        <p-card [style]="{'background':'#f8f9fa'}" class="total-card mt-4 border border-gray-200 rounded">
          <h4 class="text-lg font-semibold text-gray-800">{{ 'TOTAL_NET' | translate }}: {{totalValue | currency}}</h4>
        </p-card>
      </div>
    </p-card>

    <!-- Medio de pago - Versión mejorada -->
    <p-card class="mb-4" [style]="{ 'border': '1px solid #e5e7eb', 'box-shadow': '0 1px 3px rgba(0,0,0,0.05)', 'margin-bottom': '1.5rem' }">
      <div class="p-4">
        <h3 class="text-lg font-semibold mb-4 text-gray-800 flex items-center">
          <i class="pi pi-credit-card mr-2 mt-1 text-blue-500"></i>
          {{ 'PAYMENT_METHOD' | translate }}
        </h3>

        <div class="payment-array space-y-4">
          @for(paymentMethod of paymentMethodsArray; track paymentMethod; let i = $index) {
          <div
            class="payment-container grid grid-cols-1 md:grid-cols-12 gap-4 p-4 rounded-lg bg-gray-50/30 hover:bg-gray-50/50 transition-colors">
            <!-- Medio de pago -->
            <div class="md:col-span-4">
              <label class="block font-medium mb-2 text-gray-700 text-sm">{{ 'PAYMENT_METHOD' | translate }}</label>
              <div class="bg-white border border-gray-200 rounded-md">
                <p-select
                  [options]="paymentMethodOptions"
                  formControlName="paymentMethod"
                  placeholder="{{ 'SELECT_PAYMENT_METHOD' | translate }}"
                  optionLabel="name"
                  class="w-full"
                  [ngClass]="{'ng-invalid ng-dirty': form.get('paymentMethod')?.invalid && form.get('paymentMethod')?.touched}"
                  [filter]="true"
                  filterBy="name"
                  optionLabel="name"
                  [showClear]="true"
                />
              </div>
            </div>

            <!-- Número de autorización -->
            <div class="md:col-span-3">
              <label class="block font-medium mb-2 text-gray-700 text-sm">{{'AUTHORIZATION_NUMBER' | translate}}</label>
              <div class="bg-white border border-gray-200 rounded-md overflow-auto">
                <input
                  type="text"
                  pInputText
                  placeholder="{{ 'ENTER_AUTHORIZATION_NUMBER' | translate }}"
                  class="w-full text-sm border-none"
                  formControlName="authorizationNumber"
                  [ngClass]="{'ng-invalid ng-dirty': form.get('authorizationNumber')?.invalid && form.get('authorizationNumber')?.touched}"
                />
              </div>
            </div>

            <!-- Valor -->
            <div class="md:col-span-3">
              <label class="block font-medium mb-2 text-gray-700 text-sm">{{'VALUE' | translate}}</label>
              <input
                type="text"
                pInputText
                placeholder="0.00"
                class="w-full text-sm border-none"
                formControlName="paymentValue"
                [ngClass]="{'ng-invalid ng-dirty': form.get('paymentValue')?.invalid && form.get('paymentValue')?.touched}"
              />
            </div>

            <!-- Botón eliminar -->
            <div class="md:col-span-2 flex items-center">
              <p-button
                icon="pi pi-trash"
                [rounded]="true"
                [text]="true"
                severity="danger"
                styleClass="hover:bg-red-50 transition-colors"
                (click)="removePayment(i)">
              </p-button>
            </div>
          </div>
          }

          <!-- Botón Añadir -->
          <p class="add-text mt-4 flex items-center text-blue-500 cursor-pointer hover:text-blue-700"
            (click)="addPayment()">
            <i class="pi pi-plus mr-2"></i> {{ 'ADD_HALF_PAYMENT' | translate }}
          </p>
        </div>
      </div>
    </p-card>

    <!-- Total a pagar -->
    <p-card [style]="{ 'border': '1px solid #e2e8f0', 'box-shadow': 'none' }">
      <div class="total-pagar-container">
        <h3 class="text-lg font-semibold mb-2">{{ 'TOTAL_TO_PAY' | translate }}</h3>
        <p class="total-amount text-2xl font-bold mb-4 text-blue-600">{{totalValue | currency}}</p>
      </div>

      <div class="button-container mt-4 flex justify-content-around">
        <p-button
          label="{{ 'CANCEL' | translate }}"
          (click)="cancel()"
          [raised]="true"
          severity="secondary"
        >
        </p-button>

        <p-button
          label="{{ 'SAVE' | translate }}"
          (click)="save()"
          [raised]="true"
          [disabled]="form.invalid"
        >
        </p-button>

        <p-button
          label="{{ 'SAVE_AND_SEND' | translate }}"
          (click)="saveAndSend()"
          [raised]="true"
          [disabled]="form.invalid"
        >
        </p-button>
      </div>
    </p-card>
  </form>
</div>
